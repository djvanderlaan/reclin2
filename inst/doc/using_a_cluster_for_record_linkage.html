<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang xml:lang>
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="Jan van der Laan" />
  <title>Using a cluster for record linkage</title>
  <style type="text/css">
      code{white-space: pre-wrap;}
      span.smallcaps{font-variant: small-caps;}
      span.underline{text-decoration: underline;}
      div.column{display: inline-block; vertical-align: top; width: 50%;}
  </style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <style type="text/css">
body {
max-width: 50rem;
margin-left: auto;
margin-right: auto;
font-family: system-ui;
color: lightgray;
background: #555555;
}
p, li {
text-align: justify;
}
pre {
background: #444;
padding: 0.5rem;
}
h1, h2, h3, h4, h5 {
color: orange;
font-weight: bold;
}
h4, h5 {
color: inherit;
}
h2 {
margin-top: 3rem;
}
a {
color: orange;
}
a:hover {
color: lightblue;
}
pre code {
color: white;
background: inherit;
padding: 0;
}
code {
color: #e5c892;
background: #444;
padding: 0.2rem;
}

p.author {
font-weight : bold;
color: orange;
}
</style>
</head>
<body>
<header id="title-block-header">
<h1 class="title">Using a cluster for record linkage</h1>
<p class="author">Jan van der Laan</p>
</header>
<!--
%\VignetteEngine{simplermarkdown::mdweave_to_html}
%\VignetteIndexEntry{Using a cluster for record linkage}
-->
<h2 id="introduction">Introduction</h2>
<p><code>reclin2</code> has the functionality to use a cluster created by <code>parallel</code> or <code>snow</code> for record linkage. There are a couple of advantages to this. First, record linkage can be a computationally intensive problem as all records from both datasets have to be compared to each other. Splitting the computation over multiple cores or CPU’s can give a substantial speed benefit. The problem easily to parallelize. Second, when using a <code>snow</code> cluster, the computation can be distributed over multiple machines allowing <code>reclin2</code> to use the memory of these multiple machined. Besides computationally intensive, record linkage can also be memory intensive as all pairs are stored in memory.</p>
<p>Parallelization over <code>k</code> cluster nodes is realised by randomly splitting the first dataset <code>x</code> into <code>k</code> equally sized parts and distribution over the nodes. The second dataset <code>y</code> is copied to each of the nodes. Therefore, it is beneficial for memory consumption if the first dataset is the largest of the two. On each node the local <code>y</code> is compared to the local <code>x</code> and a local set of pairs is generated. For most operations there exist methods for <code>cluster_pairs</code>. These usually consist of running the operations for the regular <code>pairs</code> on each of the nodes.</p>
<p>Below an example is given using a small cluster. It is assumed that the reader has read the introduction vignette and knows the general procedure of record linkage.</p>
<h2 id="basic-example">Basic example</h2>
<p>In this example the example in the introduction vignette is repeated using a cluster.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">library</span>(reclin2)</a></code></pre></div>
<p>We will work with a pair of data sets with artificial data. They are tiny, but that allows us to see what happens. In this example we will perform ‘classic’ probabilistic record linkage.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">data</span>(<span class="st">&quot;linkexample1&quot;</span>, <span class="st">&quot;linkexample2&quot;</span>)</a>
<a class="sourceLine" id="cb2-2" title="2"></a>
<a class="sourceLine" id="cb2-3" title="3"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(linkexample1)</a>
<a class="sourceLine" id="cb2-4" title="4">  id lastname firstname    address sex postcode</a>
<a class="sourceLine" id="cb2-5" title="5"><span class="dv">1</span>  <span class="dv">1</span>    Smith      Anna <span class="dv">12</span> Mainstr   F  <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-6" title="6"><span class="dv">2</span>  <span class="dv">2</span>    Smith    George <span class="dv">12</span> Mainstr   M  <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-7" title="7"><span class="dv">3</span>  <span class="dv">3</span>  Johnson      Anna <span class="dv">61</span> Mainstr   F  <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-8" title="8"><span class="dv">4</span>  <span class="dv">4</span>  Johnson   Charles <span class="dv">61</span> Mainstr   M  <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-9" title="9"><span class="dv">5</span>  <span class="dv">5</span>  Johnson    Charly <span class="dv">61</span> Mainstr   M  <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-10" title="10"><span class="dv">6</span>  <span class="dv">6</span> Schwartz       Ben  <span class="dv">1</span> Eaststr   M  <span class="dv">6789</span> XY</a>
<a class="sourceLine" id="cb2-11" title="11"></a>
<a class="sourceLine" id="cb2-12" title="12"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(linkexample2)</a>
<a class="sourceLine" id="cb2-13" title="13">  id lastname firstname       address  sex postcode</a>
<a class="sourceLine" id="cb2-14" title="14"><span class="dv">1</span>  <span class="dv">2</span>    Smith    Gearge <span class="dv">12</span> Mainstreet <span class="op">&lt;</span><span class="ot">NA</span><span class="op">&gt;</span><span class="st">  </span><span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-15" title="15"><span class="dv">2</span>  <span class="dv">3</span>   Jonson        A. <span class="dv">61</span> Mainstreet    F  <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-16" title="16"><span class="dv">3</span>  <span class="dv">4</span>  Johnson   Charles    <span class="dv">61</span> Mainstr    F  <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb2-17" title="17"><span class="dv">4</span>  <span class="dv">6</span> Schwartz       Ben        <span class="dv">1</span> Main    M  <span class="dv">6789</span> XY</a>
<a class="sourceLine" id="cb2-18" title="18"><span class="dv">5</span>  <span class="dv">7</span> Schwartz      Anna     <span class="dv">1</span> Eaststr    F  <span class="dv">6789</span> XY</a></code></pre></div>
<p>We first have to start a cluster. Pairs can then be generated using any of the <code>cluster_pair_*</code> functions.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">library</span>(parallel)</a>
<a class="sourceLine" id="cb3-2" title="2"></a>
<a class="sourceLine" id="cb3-3" title="3"><span class="op">&gt;</span><span class="st"> </span>cl &lt;-<span class="st"> </span><span class="kw">makeCluster</span>(<span class="dv">2</span>)</a>
<a class="sourceLine" id="cb3-4" title="4"></a>
<a class="sourceLine" id="cb3-5" title="5"><span class="op">&gt;</span><span class="st"> </span>pairs &lt;-<span class="st"> </span><span class="kw">cluster_pair_blocking</span>(cl, linkexample1, linkexample2, </a>
<a class="sourceLine" id="cb3-6" title="6"><span class="op">+</span><span class="st">     &quot;postcode&quot;</span>)</a>
<a class="sourceLine" id="cb3-7" title="7"></a>
<a class="sourceLine" id="cb3-8" title="8"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(pairs)</a>
<a class="sourceLine" id="cb3-9" title="9">  Cluster <span class="st">&#39;default&#39;</span> with size<span class="op">:</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb3-10" title="10">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb3-11" title="11">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb3-12" title="12">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">17</span> pairs</a>
<a class="sourceLine" id="cb3-13" title="13">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb3-14" title="14"></a>
<a class="sourceLine" id="cb3-15" title="15">Showing a random selection of pairs<span class="op">:</span></a>
<a class="sourceLine" id="cb3-16" title="16"><span class="st">    </span>.x .y</a>
<a class="sourceLine" id="cb3-17" title="17"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-18" title="18"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-19" title="19"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span></a>
<a class="sourceLine" id="cb3-20" title="20"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">3</span></a>
<a class="sourceLine" id="cb3-21" title="21"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">2</span></a>
<a class="sourceLine" id="cb3-22" title="22"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">2</span></a>
<a class="sourceLine" id="cb3-23" title="23"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-24" title="24"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">2</span></a>
<a class="sourceLine" id="cb3-25" title="25"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">3</span></a>
<a class="sourceLine" id="cb3-26" title="26"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">2</span></a></code></pre></div>
<p>The print function collects a few (max 6) pairs from each of the nodes and shows those. Other <code>cluster_pair_*</code> functions are <code>cluster_pair</code> and <code>cluster_pair_minsim</code>.</p>
<p>The <code>cluster_pair_*</code> functions return an object of type <code>cluster_pairs</code>. Most other methods work the same as for regular pairs. For example, to compare the pairs on variables:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">compare_pairs</span>(pairs, <span class="dt">on =</span> <span class="kw">c</span>(<span class="st">&quot;lastname&quot;</span>, <span class="st">&quot;firstname&quot;</span>, </a>
<a class="sourceLine" id="cb4-2" title="2"><span class="op">+</span><span class="st">     &quot;address&quot;</span>, <span class="st">&quot;sex&quot;</span>), <span class="dt">default_comparator =</span> <span class="kw">jaro_winkler</span>(<span class="fl">0.9</span>), </a>
<a class="sourceLine" id="cb4-3" title="3"><span class="op">+</span><span class="st">     </span><span class="dt">inplace =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb4-4" title="4"></a>
<a class="sourceLine" id="cb4-5" title="5"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(pairs)</a>
<a class="sourceLine" id="cb4-6" title="6">  Cluster <span class="st">&#39;default&#39;</span> with size<span class="op">:</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb4-7" title="7">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb4-8" title="8">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb4-9" title="9">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">17</span> pairs</a>
<a class="sourceLine" id="cb4-10" title="10">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb4-11" title="11"></a>
<a class="sourceLine" id="cb4-12" title="12">Showing a random selection of pairs<span class="op">:</span></a>
<a class="sourceLine" id="cb4-13" title="13"><span class="st">    </span>.x .y lastname firstname   address sex</a>
<a class="sourceLine" id="cb4-14" title="14"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.5833333</span> <span class="fl">0.8641026</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-15" title="15"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">4</span> <span class="fl">1.000000</span> <span class="fl">1.0000000</span> <span class="fl">0.6111111</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-16" title="16"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.4642857</span> <span class="fl">0.9333333</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-17" title="17"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.5555556</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb4-18" title="18"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.8492063</span> <span class="fl">1.0000000</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-19" title="19"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.5396825</span> <span class="fl">0.9333333</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-20" title="20"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.0000000</span> <span class="fl">0.9230769</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb4-21" title="21"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.6428571</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb4-22" title="22"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.5833333</span> <span class="fl">0.9230769</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb4-23" title="23"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">1.0000000</span> <span class="fl">1.0000000</span>   <span class="dv">0</span></a></code></pre></div>
<p>The code above was copy-pasted from the introduction. Here the argument <code>inplace = TRUE</code> was used, which adds the new variables to the existing pairs. One difference between regular <code>pairs</code> and <code>cluster_pairs</code> is that most methods will modify the existing pairs in place. Therefore, <code>inplace</code> is ignored here and we should use:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">compare_pairs</span>(pairs, <span class="dt">on =</span> <span class="kw">c</span>(<span class="st">&quot;lastname&quot;</span>, <span class="st">&quot;firstname&quot;</span>, </a>
<a class="sourceLine" id="cb5-2" title="2"><span class="op">+</span><span class="st">     &quot;address&quot;</span>, <span class="st">&quot;sex&quot;</span>), <span class="dt">default_comparator =</span> <span class="kw">jaro_winkler</span>(<span class="fl">0.9</span>))</a>
<a class="sourceLine" id="cb5-3" title="3"></a>
<a class="sourceLine" id="cb5-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(pairs)</a>
<a class="sourceLine" id="cb5-5" title="5">  Cluster <span class="st">&#39;default&#39;</span> with size<span class="op">:</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb5-6" title="6">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb5-7" title="7">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb5-8" title="8">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">17</span> pairs</a>
<a class="sourceLine" id="cb5-9" title="9">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb5-10" title="10"></a>
<a class="sourceLine" id="cb5-11" title="11">Showing a random selection of pairs<span class="op">:</span></a>
<a class="sourceLine" id="cb5-12" title="12"><span class="st">    </span>.x .y lastname firstname   address sex</a>
<a class="sourceLine" id="cb5-13" title="13"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">5</span> <span class="fl">1.000000</span> <span class="fl">0.5277778</span> <span class="fl">1.0000000</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-14" title="14"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.5833333</span> <span class="fl">0.8641026</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-15" title="15"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">1</span> <span class="fl">1.000000</span> <span class="fl">0.4722222</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb5-16" title="16"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.4642857</span> <span class="fl">0.9333333</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-17" title="17"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">4</span> <span class="fl">1.000000</span> <span class="fl">1.0000000</span> <span class="fl">0.6111111</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-18" title="18"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.0000000</span> <span class="fl">0.8641026</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-19" title="19"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">1.0000000</span> <span class="fl">1.0000000</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb5-20" title="20"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.4642857</span> <span class="fl">1.0000000</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb5-21" title="21"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.6428571</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb5-22" title="22"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.0000000</span> <span class="fl">0.9230769</span>   <span class="dv">0</span></a></code></pre></div>
<p>Most methods for <code>cluster_pairs</code> do have a <code>new_name</code> argument that will generate a new set of pairs on the cluster nodes. For example, the following code will generate a new set of pairs and will not modify the existing pairs:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1"><span class="op">&gt;</span><span class="st"> </span>pairs2 &lt;-<span class="st"> </span><span class="kw">compare_pairs</span>(pairs, <span class="dt">on =</span> <span class="kw">c</span>(<span class="st">&quot;lastname&quot;</span>, </a>
<a class="sourceLine" id="cb6-2" title="2"><span class="op">+</span><span class="st">     &quot;firstname&quot;</span>, <span class="st">&quot;address&quot;</span>, <span class="st">&quot;sex&quot;</span>), <span class="dt">new_name =</span> <span class="st">&quot;pairs2&quot;</span>)</a>
<a class="sourceLine" id="cb6-3" title="3"></a>
<a class="sourceLine" id="cb6-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(pairs2)</a>
<a class="sourceLine" id="cb6-5" title="5">  Cluster <span class="st">&#39;pairs2&#39;</span> with size<span class="op">:</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb6-6" title="6">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb6-7" title="7">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb6-8" title="8">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">17</span> pairs</a>
<a class="sourceLine" id="cb6-9" title="9">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb6-10" title="10"></a>
<a class="sourceLine" id="cb6-11" title="11">Showing a random selection of pairs<span class="op">:</span></a>
<a class="sourceLine" id="cb6-12" title="12"><span class="st">    </span>.x .y lastname firstname address   sex</a>
<a class="sourceLine" id="cb6-13" title="13"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">1</span>    <span class="ot">FALSE</span>     <span class="ot">FALSE</span>   <span class="ot">FALSE</span>    <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-14" title="14"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">3</span>     <span class="ot">TRUE</span>     <span class="ot">FALSE</span>    <span class="ot">TRUE</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb6-15" title="15"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">5</span>     <span class="ot">TRUE</span>     <span class="ot">FALSE</span>    <span class="ot">TRUE</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb6-16" title="16"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span>    <span class="ot">FALSE</span>     <span class="ot">FALSE</span>   <span class="ot">FALSE</span>  <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb6-17" title="17"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">4</span>     <span class="ot">TRUE</span>      <span class="ot">TRUE</span>   <span class="ot">FALSE</span>  <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb6-18" title="18"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">3</span>     <span class="ot">TRUE</span>     <span class="ot">FALSE</span>    <span class="ot">TRUE</span>  <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb6-19" title="19"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">2</span>    <span class="ot">FALSE</span>     <span class="ot">FALSE</span>   <span class="ot">FALSE</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb6-20" title="20"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">1</span>    <span class="ot">FALSE</span>     <span class="ot">FALSE</span>   <span class="ot">FALSE</span>    <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-21" title="21"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">2</span>    <span class="ot">FALSE</span>     <span class="ot">FALSE</span>   <span class="ot">FALSE</span> <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb6-22" title="22"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">1</span>    <span class="ot">FALSE</span>     <span class="ot">FALSE</span>   <span class="ot">FALSE</span>    <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-23" title="23"></a>
<a class="sourceLine" id="cb6-24" title="24"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(pairs)</a>
<a class="sourceLine" id="cb6-25" title="25">  Cluster <span class="st">&#39;default&#39;</span> with size<span class="op">:</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb6-26" title="26">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb6-27" title="27">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb6-28" title="28">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">17</span> pairs</a>
<a class="sourceLine" id="cb6-29" title="29">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb6-30" title="30"></a>
<a class="sourceLine" id="cb6-31" title="31">Showing a random selection of pairs<span class="op">:</span></a>
<a class="sourceLine" id="cb6-32" title="32"><span class="st">    </span>.x .y lastname firstname   address sex</a>
<a class="sourceLine" id="cb6-33" title="33"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.5555556</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-34" title="34"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">1</span> <span class="fl">1.000000</span> <span class="fl">0.4722222</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-35" title="35"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.8492063</span> <span class="fl">1.0000000</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-36" title="36"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.5833333</span> <span class="fl">0.8641026</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-37" title="37"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.4642857</span> <span class="fl">0.9333333</span>   <span class="dv">1</span></a>
<a class="sourceLine" id="cb6-38" title="38"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.6428571</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-39" title="39"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.5396825</span> <span class="fl">0.9333333</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-40" title="40"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">1</span> <span class="fl">1.000000</span> <span class="fl">0.8888889</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span></a>
<a class="sourceLine" id="cb6-41" title="41"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.0000000</span> <span class="fl">0.8641026</span>   <span class="dv">0</span></a>
<a class="sourceLine" id="cb6-42" title="42"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.4722222</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span></a></code></pre></div>
<p>The function <code>compare_vars</code> offers more flexibility than <code>compare_pairs</code>. It can for example compare multiple variables at the same time (e.g. compare birth day and month allowing for swaps) or generate multiple results from comparing on one variable. This method also works on <code>cluster_pairs</code>.</p>
<p>The next step in the process, is to determine which pairs of records belong to the same entity and which do not. As in the introduction vignette we will use the classic method. Again, we hardly need to change the code from the introduction:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1"><span class="op">&gt;</span><span class="st"> </span>m &lt;-<span class="st"> </span><span class="kw">problink_em</span>(<span class="op">~</span>lastname <span class="op">+</span><span class="st"> </span>firstname <span class="op">+</span><span class="st"> </span>address <span class="op">+</span><span class="st"> </span></a>
<a class="sourceLine" id="cb7-2" title="2"><span class="op">+</span><span class="st">     </span>sex, <span class="dt">data =</span> pairs)</a>
<a class="sourceLine" id="cb7-3" title="3"></a>
<a class="sourceLine" id="cb7-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(m)</a>
<a class="sourceLine" id="cb7-5" title="5">M<span class="op">-</span><span class="st"> </span>and u<span class="op">-</span>probabilities estimated by the EM<span class="op">-</span>algorithm<span class="op">:</span></a>
<a class="sourceLine" id="cb7-6" title="6"><span class="st">  </span>Variable M<span class="op">-</span>probability U<span class="op">-</span>probability</a>
<a class="sourceLine" id="cb7-7" title="7">  lastname     <span class="fl">0.9990000</span>   <span class="fl">0.001152679</span></a>
<a class="sourceLine" id="cb7-8" title="8"> firstname     <span class="fl">0.1999999</span>   <span class="fl">0.000100000</span></a>
<a class="sourceLine" id="cb7-9" title="9">   address     <span class="fl">0.8999206</span>   <span class="fl">0.285831118</span></a>
<a class="sourceLine" id="cb7-10" title="10">       sex     <span class="fl">0.3002011</span>   <span class="fl">0.285427112</span></a>
<a class="sourceLine" id="cb7-11" title="11"></a>
<a class="sourceLine" id="cb7-12" title="12">Matching probability<span class="op">:</span><span class="st"> </span><span class="dv">0</span>.<span class="fl">5885595.</span></a>
<a class="sourceLine" id="cb7-13" title="13"></a>
<a class="sourceLine" id="cb7-14" title="14"><span class="op">&gt;</span><span class="st"> </span>pairs &lt;-<span class="st"> </span><span class="kw">predict</span>(m, <span class="dt">pairs =</span> pairs, <span class="dt">add =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb7-15" title="15"></a>
<a class="sourceLine" id="cb7-16" title="16"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(pairs)</a>
<a class="sourceLine" id="cb7-17" title="17">  Cluster <span class="st">&#39;default&#39;</span> with size<span class="op">:</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb7-18" title="18">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb7-19" title="19">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb7-20" title="20">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">17</span> pairs</a>
<a class="sourceLine" id="cb7-21" title="21">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb7-22" title="22"></a>
<a class="sourceLine" id="cb7-23" title="23">Showing a random selection of pairs<span class="op">:</span></a>
<a class="sourceLine" id="cb7-24" title="24"><span class="st">    </span>.x .y lastname firstname   address sex    weights</a>
<a class="sourceLine" id="cb7-25" title="25"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.8492063</span> <span class="fl">1.0000000</span>   <span class="dv">0</span>  <span class="fl">8.5458257</span></a>
<a class="sourceLine" id="cb7-26" title="26"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">5</span> <span class="fl">1.000000</span> <span class="fl">0.5277778</span> <span class="fl">1.0000000</span>   <span class="dv">0</span>  <span class="fl">7.9139248</span></a>
<a class="sourceLine" id="cb7-27" title="27"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.5833333</span> <span class="fl">0.8641026</span>   <span class="dv">1</span> <span class="fl">-5.9463949</span></a>
<a class="sourceLine" id="cb7-28" title="28"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">4</span> <span class="fl">1.000000</span> <span class="fl">1.0000000</span> <span class="fl">0.6111111</span>   <span class="dv">1</span> <span class="fl">14.6796595</span></a>
<a class="sourceLine" id="cb7-29" title="29"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.4642857</span> <span class="fl">0.9333333</span>   <span class="dv">1</span>  <span class="fl">0.8042090</span></a>
<a class="sourceLine" id="cb7-30" title="30"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.5833333</span> <span class="fl">0.9230769</span>   <span class="dv">1</span>  <span class="fl">4.0674910</span></a>
<a class="sourceLine" id="cb7-31" title="31"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">1</span> <span class="fl">1.000000</span> <span class="fl">0.8888889</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span>  <span class="fl">8.6064218</span></a>
<a class="sourceLine" id="cb7-32" title="32"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.5396825</span> <span class="fl">0.9333333</span>   <span class="dv">0</span>  <span class="fl">0.7937508</span></a>
<a class="sourceLine" id="cb7-33" title="33"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.0000000</span> <span class="fl">0.9230769</span>   <span class="dv">0</span>  <span class="fl">3.6961688</span></a>
<a class="sourceLine" id="cb7-34" title="34"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.0000000</span> <span class="fl">0.8641026</span>   <span class="dv">0</span> <span class="fl">-6.3177171</span></a></code></pre></div>
<p>We can then select the pairs with a weight above a threshold.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1"><span class="op">&gt;</span><span class="st"> </span>pairs &lt;-<span class="st"> </span><span class="kw">select_threshold</span>(pairs, <span class="st">&quot;threshold&quot;</span>, <span class="dt">score =</span> <span class="st">&quot;weights&quot;</span>, </a>
<a class="sourceLine" id="cb8-2" title="2"><span class="op">+</span><span class="st">     </span><span class="dt">threshold =</span> <span class="dv">8</span>)</a>
<a class="sourceLine" id="cb8-3" title="3"></a>
<a class="sourceLine" id="cb8-4" title="4"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(pairs)</a>
<a class="sourceLine" id="cb8-5" title="5">  Cluster <span class="st">&#39;default&#39;</span> with size<span class="op">:</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb8-6" title="6">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb8-7" title="7">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb8-8" title="8">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">17</span> pairs</a>
<a class="sourceLine" id="cb8-9" title="9">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb8-10" title="10"></a>
<a class="sourceLine" id="cb8-11" title="11">Showing a random selection of pairs<span class="op">:</span></a>
<a class="sourceLine" id="cb8-12" title="12"><span class="st">    </span>.x .y lastname firstname   address sex    weights threshold</a>
<a class="sourceLine" id="cb8-13" title="13"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.4642857</span> <span class="fl">0.9333333</span>   <span class="dv">1</span>  <span class="fl">0.8042090</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-14" title="14"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span> <span class="fl">0.000000</span> <span class="fl">0.5833333</span> <span class="fl">0.8641026</span>   <span class="dv">1</span> <span class="fl">-5.9463949</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-15" title="15"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">1</span> <span class="fl">1.000000</span> <span class="fl">0.4722222</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span>  <span class="fl">7.7103862</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-16" title="16"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.8492063</span> <span class="fl">1.0000000</span>   <span class="dv">0</span>  <span class="fl">8.5458257</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb8-17" title="17"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.5555556</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span>  <span class="fl">0.6717426</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-18" title="18"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.6428571</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span>  <span class="fl">0.7713174</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-19" title="19"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.4642857</span> <span class="fl">1.0000000</span>   <span class="dv">1</span>  <span class="fl">7.9350221</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-20" title="20"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.0000000</span> <span class="fl">0.9230769</span>   <span class="dv">0</span>  <span class="fl">3.6961688</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-21" title="21"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.4722222</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span>  <span class="fl">0.6017106</span>     <span class="ot">FALSE</span></a>
<a class="sourceLine" id="cb8-22" title="22"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.5833333</span> <span class="fl">0.9230769</span>   <span class="dv">1</span>  <span class="fl">4.0674910</span>     <span class="ot">FALSE</span></a></code></pre></div>
<p>And this is roughly where we have to stop working with <code>cluster_pairs</code>. The subset of selected pairs remaining should now be small enough that we can comfortably work locally. The most computationally intensive steps have been done. When we are not sure exactly what the threshold should be, we can also work with a more conservative threshold. That should still give us enough of a reduction in pairs that we can work locally. Using <code>cluster_collect</code> we can copy the selected pairs (or all pairs) locally:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1"><span class="op">&gt;</span><span class="st"> </span>pairs &lt;-<span class="st"> </span><span class="kw">select_threshold</span>(pairs, <span class="st">&quot;threshold&quot;</span>, <span class="dt">score =</span> <span class="st">&quot;weights&quot;</span>, </a>
<a class="sourceLine" id="cb9-2" title="2"><span class="op">+</span><span class="st">     </span><span class="dt">threshold =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb9-3" title="3"></a>
<a class="sourceLine" id="cb9-4" title="4"><span class="op">&gt;</span><span class="st"> </span>local_pairs &lt;-<span class="st"> </span><span class="kw">cluster_collect</span>(pairs, <span class="st">&quot;threshold&quot;</span>)</a>
<a class="sourceLine" id="cb9-5" title="5"></a>
<a class="sourceLine" id="cb9-6" title="6"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(local_pairs)</a>
<a class="sourceLine" id="cb9-7" title="7">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">6</span> records</a>
<a class="sourceLine" id="cb9-8" title="8">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb9-9" title="9">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">15</span> pairs</a>
<a class="sourceLine" id="cb9-10" title="10">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb9-11" title="11"></a>
<a class="sourceLine" id="cb9-12" title="12">    .x .y lastname firstname   address sex    weights threshold</a>
<a class="sourceLine" id="cb9-13" title="13"> <span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">1</span> <span class="fl">1.000000</span> <span class="fl">0.4722222</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span>  <span class="fl">7.7103862</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-14" title="14"> <span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.4642857</span> <span class="fl">0.9333333</span>   <span class="dv">1</span>  <span class="fl">0.8042090</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-15" title="15"> <span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.5555556</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span>  <span class="fl">0.6717426</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-16" title="16"> <span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.0000000</span> <span class="fl">0.9230769</span>   <span class="dv">0</span>  <span class="fl">3.6961688</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-17" title="17"> <span class="dv">5</span><span class="op">:</span><span class="st">  </span><span class="dv">5</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.8492063</span> <span class="fl">1.0000000</span>   <span class="dv">0</span>  <span class="fl">8.5458257</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-18" title="18"> <span class="dv">6</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">4</span> <span class="fl">1.000000</span> <span class="fl">1.0000000</span> <span class="fl">0.6111111</span>   <span class="dv">1</span> <span class="fl">14.6796595</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-19" title="19"> <span class="dv">7</span><span class="op">:</span><span class="st">  </span><span class="dv">6</span>  <span class="dv">5</span> <span class="fl">1.000000</span> <span class="fl">0.5277778</span> <span class="fl">1.0000000</span>   <span class="dv">0</span>  <span class="fl">7.9139248</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-20" title="20"> <span class="dv">8</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">1</span> <span class="fl">1.000000</span> <span class="fl">0.8888889</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span>  <span class="fl">8.6064218</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-21" title="21"> <span class="dv">9</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">3</span> <span class="fl">0.447619</span> <span class="fl">0.5396825</span> <span class="fl">0.9333333</span>   <span class="dv">0</span>  <span class="fl">0.7937508</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-22" title="22"><span class="dv">10</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.4722222</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span>  <span class="fl">0.6017106</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-23" title="23"><span class="dv">11</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.5833333</span> <span class="fl">0.9230769</span>   <span class="dv">1</span>  <span class="fl">4.0674910</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-24" title="24"><span class="dv">12</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">0.4642857</span> <span class="fl">1.0000000</span>   <span class="dv">1</span>  <span class="fl">7.9350221</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-25" title="25"><span class="dv">13</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">1</span> <span class="fl">0.447619</span> <span class="fl">0.6428571</span> <span class="fl">0.8641026</span>  <span class="ot">NA</span>  <span class="fl">0.7713174</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-26" title="26"><span class="dv">14</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">2</span> <span class="fl">0.952381</span> <span class="fl">0.0000000</span> <span class="fl">0.9230769</span>   <span class="dv">0</span>  <span class="fl">3.6961688</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb9-27" title="27"><span class="dv">15</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">3</span> <span class="fl">1.000000</span> <span class="fl">1.0000000</span> <span class="fl">1.0000000</span>   <span class="dv">0</span> <span class="fl">15.4915816</span>      <span class="ot">TRUE</span></a></code></pre></div>
<p><code>local_pairs</code> is a regular <code>pairs</code> object (and therefore a <code>data.table</code>) which can be operated upon as any <code>pairs</code> object. <code>cluster_collect</code> also has the option <code>clear</code> which when <code>TRUE</code> will delete the pairs on the cluster nodes. After this we can use the code from the introduction vignette:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="op">&gt;</span><span class="st"> </span>local_pairs &lt;-<span class="st"> </span><span class="kw">compare_vars</span>(local_pairs, <span class="st">&quot;truth&quot;</span>, </a>
<a class="sourceLine" id="cb10-2" title="2"><span class="op">+</span><span class="st">     </span><span class="dt">on_x =</span> <span class="st">&quot;id&quot;</span>, <span class="dt">on_y =</span> <span class="st">&quot;id&quot;</span>)</a>
<a class="sourceLine" id="cb10-3" title="3"></a>
<a class="sourceLine" id="cb10-4" title="4"><span class="op">&gt;</span><span class="st"> </span>local_pairs &lt;-<span class="st"> </span><span class="kw">select_n_to_m</span>(local_pairs, <span class="st">&quot;weights&quot;</span>, </a>
<a class="sourceLine" id="cb10-5" title="5"><span class="op">+</span><span class="st">     </span><span class="dt">variable =</span> <span class="st">&quot;ntom&quot;</span>, <span class="dt">threshold =</span> <span class="dv">0</span>)</a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="op">&gt;</span><span class="st"> </span><span class="kw">table</span>(local_pairs<span class="op">$</span>truth, local_pairs<span class="op">$</span>ntom)</a>
<a class="sourceLine" id="cb10-8" title="8">       </a>
<a class="sourceLine" id="cb10-9" title="9">        <span class="ot">FALSE</span> <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb10-10" title="10">  <span class="ot">FALSE</span>     <span class="dv">9</span>    <span class="dv">4</span></a>
<a class="sourceLine" id="cb10-11" title="11">  <span class="ot">TRUE</span>      <span class="dv">2</span>    <span class="dv">0</span></a>
<a class="sourceLine" id="cb10-12" title="12"></a>
<a class="sourceLine" id="cb10-13" title="13"><span class="op">&gt;</span><span class="st"> </span>linked_data_set &lt;-<span class="st"> </span><span class="kw">link</span>(local_pairs, <span class="dt">selection =</span> <span class="st">&quot;ntom&quot;</span>)</a>
<a class="sourceLine" id="cb10-14" title="14"></a>
<a class="sourceLine" id="cb10-15" title="15"><span class="op">&gt;</span><span class="st"> </span><span class="kw">print</span>(linked_data_set)</a>
<a class="sourceLine" id="cb10-16" title="16">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">4</span> pairs</a>
<a class="sourceLine" id="cb10-17" title="17"></a>
<a class="sourceLine" id="cb10-18" title="18">   .y .x id.x lastname.x firstname.x  address.x sex.x postcode.x .id id.y</a>
<a class="sourceLine" id="cb10-19" title="19"><span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">2</span>    <span class="dv">5</span>    Johnson      Charly <span class="dv">61</span> Mainstr     M    <span class="dv">1234</span> AB   <span class="dv">5</span>    <span class="dv">2</span></a>
<a class="sourceLine" id="cb10-20" title="20"><span class="dv">2</span><span class="op">:</span><span class="st">  </span><span class="dv">2</span>  <span class="dv">3</span>    <span class="dv">6</span>   Schwartz         Ben  <span class="dv">1</span> Eaststr     M    <span class="dv">6789</span> XY   <span class="dv">6</span>    <span class="dv">3</span></a>
<a class="sourceLine" id="cb10-21" title="21"><span class="dv">3</span><span class="op">:</span><span class="st">  </span><span class="dv">3</span>  <span class="dv">4</span>    <span class="dv">2</span>      Smith      George <span class="dv">12</span> Mainstr     M    <span class="dv">1234</span> AB   <span class="dv">2</span>    <span class="dv">4</span></a>
<a class="sourceLine" id="cb10-22" title="22"><span class="dv">4</span><span class="op">:</span><span class="st">  </span><span class="dv">4</span>  <span class="dv">6</span>    <span class="dv">4</span>    Johnson     Charles <span class="dv">61</span> Mainstr     M    <span class="dv">1234</span> AB   <span class="dv">4</span>    <span class="dv">6</span></a>
<a class="sourceLine" id="cb10-23" title="23">   lastname.y firstname.y     address.y sex.y postcode.y</a>
<a class="sourceLine" id="cb10-24" title="24"><span class="dv">1</span><span class="op">:</span><span class="st">      </span>Smith      Gearge <span class="dv">12</span> Mainstreet  <span class="op">&lt;</span><span class="ot">NA</span><span class="op">&gt;</span><span class="st">    </span><span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb10-25" title="25"><span class="dv">2</span><span class="op">:</span><span class="st">     </span>Jonson          A. <span class="dv">61</span> Mainstreet     F    <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb10-26" title="26"><span class="dv">3</span><span class="op">:</span><span class="st">    </span>Johnson     Charles    <span class="dv">61</span> Mainstr     F    <span class="dv">1234</span> AB</a>
<a class="sourceLine" id="cb10-27" title="27"><span class="dv">4</span><span class="op">:</span><span class="st">   </span>Schwartz         Ben        <span class="dv">1</span> Main     M    <span class="dv">6789</span> XY</a></code></pre></div>
<h2 id="internals">Internals</h2>
<p>The <code>cluster_pair</code> object is a list with two elements:</p>
<ul>
<li><code>cluster</code> with a copy of the <code>parallel</code> or <code>snow</code> cluster.</li>
<li><code>name</code> the name of the environment on the cluster nodes in which the pairs are stored.</li>
</ul>
<p>On the cluster nodes there exists an environment (<code>reclin2::reclin_env</code>). For each set of pairs an environment is created in that environment containing the pairs. To demonstrate, let us get the first pair on each of the nodes:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">clusterCall</span>(pairs<span class="op">$</span>cluster, <span class="cf">function</span>(name) {</a>
<a class="sourceLine" id="cb11-2" title="2"><span class="op">+</span><span class="st">     </span>pairs &lt;-<span class="st"> </span>reclin2<span class="op">:::</span>reclin_env[[name]]<span class="op">$</span>pairs</a>
<a class="sourceLine" id="cb11-3" title="3"><span class="op">+</span><span class="st">     </span><span class="kw">head</span>(pairs, <span class="dv">1</span>)</a>
<a class="sourceLine" id="cb11-4" title="4"><span class="op">+</span><span class="st"> </span>}, <span class="dt">name =</span> pairs<span class="op">$</span>name)</a>
<a class="sourceLine" id="cb11-5" title="5">[[<span class="dv">1</span>]]</a>
<a class="sourceLine" id="cb11-6" title="6">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">3</span> records</a>
<a class="sourceLine" id="cb11-7" title="7">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb11-8" title="8">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">1</span> pairs</a>
<a class="sourceLine" id="cb11-9" title="9">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb11-10" title="10"></a>
<a class="sourceLine" id="cb11-11" title="11">   .x .y lastname firstname   address sex  weights threshold</a>
<a class="sourceLine" id="cb11-12" title="12"><span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">1</span>        <span class="dv">1</span> <span class="fl">0.4722222</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span> <span class="fl">7.710386</span>      <span class="ot">TRUE</span></a>
<a class="sourceLine" id="cb11-13" title="13"></a>
<a class="sourceLine" id="cb11-14" title="14">[[<span class="dv">2</span>]]</a>
<a class="sourceLine" id="cb11-15" title="15">  First data set<span class="op">:</span><span class="st">  </span><span class="dv">3</span> records</a>
<a class="sourceLine" id="cb11-16" title="16">  Second data set<span class="op">:</span><span class="st"> </span><span class="dv">5</span> records</a>
<a class="sourceLine" id="cb11-17" title="17">  Total number of pairs<span class="op">:</span><span class="st"> </span><span class="dv">1</span> pairs</a>
<a class="sourceLine" id="cb11-18" title="18">  Blocking on<span class="op">:</span><span class="st"> &#39;postcode&#39;</span></a>
<a class="sourceLine" id="cb11-19" title="19"></a>
<a class="sourceLine" id="cb11-20" title="20">   .x .y lastname firstname   address sex  weights threshold</a>
<a class="sourceLine" id="cb11-21" title="21"><span class="dv">1</span><span class="op">:</span><span class="st">  </span><span class="dv">1</span>  <span class="dv">1</span>        <span class="dv">1</span> <span class="fl">0.8888889</span> <span class="fl">0.9230769</span>  <span class="ot">NA</span> <span class="fl">8.606422</span>      <span class="ot">TRUE</span></a></code></pre></div>
<h2 id="some-specific-methods-for-cluster_pairs">Some specific methods for <code>cluster_pairs</code></h2>
<p>Regular <code>pairs</code> are also a <code>data.table</code>. Therefore, it is easy to manually create columns, select or aggregate. As for <code>cluster_pairs</code> the pairs are distributed over the cluster nodes, this is more difficult for <code>cluster_pairs</code>. In order to help with this, <code>reclin2</code> has two helper functions: <code>cluster_call</code> and <code>cluster_modify_pairs</code>.</p>
<p>You can pass <code>cluster_call</code> the <code>cluster_pairs</code> object and a function. This function will be called on each cluster node and will be passed the <code>pairs</code> object, the local <code>x</code> and <code>y</code> (in that order). This can be used to modify the pairs, or calculate statistics from the pairs. The result of the function calls is returned by <code>cluster_call</code>. Therefore, if the sole goal is to modify the pairs, make sure to return <code>NULL</code> (or at least something small). Below we use <code>cluster_call</code> to make a random stratified sample of pairs:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="op">&gt;</span><span class="st"> </span><span class="kw">compare_vars</span>(pairs, <span class="st">&quot;id&quot;</span>)</a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3"><span class="op">&gt;</span><span class="st"> </span><span class="kw">cluster_call</span>(pairs, <span class="cf">function</span>(pairs, ...) {</a>
<a class="sourceLine" id="cb12-4" title="4"><span class="op">+</span><span class="st">     </span>sel1 &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(pairs<span class="op">$</span>id), <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb12-5" title="5"><span class="op">+</span><span class="st">     </span>sel2 &lt;-<span class="st"> </span><span class="kw">sample</span>(<span class="kw">which</span>(<span class="op">!</span>pairs<span class="op">$</span>id), <span class="dv">2</span>)</a>
<a class="sourceLine" id="cb12-6" title="6"><span class="op">+</span><span class="st">     </span>pairs[, <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(sample, <span class="ot">FALSE</span>)]</a>
<a class="sourceLine" id="cb12-7" title="7"><span class="op">+</span><span class="st">     </span>pairs[<span class="kw">c</span>(sel1, sel2), <span class="st">`</span><span class="dt">:=</span><span class="st">`</span>(sample, <span class="ot">TRUE</span>)]</a>
<a class="sourceLine" id="cb12-8" title="8"><span class="op">+</span><span class="st">     </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb12-9" title="9"><span class="op">+</span><span class="st"> </span>})</a>
<a class="sourceLine" id="cb12-10" title="10"></a>
<a class="sourceLine" id="cb12-11" title="11"><span class="op">&gt;</span><span class="st"> </span>sample &lt;-<span class="st"> </span><span class="kw">cluster_collect</span>(pairs, <span class="st">&quot;sample&quot;</span>)</a></code></pre></div>
<p><code>cluster_modify_pairs</code> is very similar to <code>cluster_call</code> but is mainly meant for modifying the pairs object. Although in the previous example we also used <code>cluster_call</code> for that. When the function passed to <code>cluster_modify_pairs</code> returns a <code>data.table</code>, this <code>data.table</code> will overwrite the <code>pairs</code> object. <code>cluster_modify_pairs</code> also accepts a <code>new_name</code> argument. When set a new pairs object will be created.</p>
<p>Let’s use the sample from above to estimate a model and then use <code>cluster_modify_pairs</code> to add the predictions to the pairs:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode R"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="op">&gt;</span><span class="st"> </span>mglm &lt;-<span class="st"> </span><span class="kw">glm</span>(id <span class="op">~</span><span class="st"> </span>lastname <span class="op">+</span><span class="st"> </span>firstname, <span class="dt">data =</span> sample)</a>
<a class="sourceLine" id="cb13-2" title="2"></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="op">&gt;</span><span class="st"> </span><span class="kw">cluster_modify_pairs</span>(pairs, <span class="cf">function</span>(pairs, model, </a>
<a class="sourceLine" id="cb13-4" title="4"><span class="op">+</span><span class="st">     </span>...) {</a>
<a class="sourceLine" id="cb13-5" title="5"><span class="op">+</span><span class="st">     </span>pairs<span class="op">$</span>pmodel &lt;-<span class="st"> </span><span class="kw">predict</span>(model, <span class="dt">newdata =</span> pairs, <span class="dt">type =</span> <span class="st">&quot;response&quot;</span>)</a>
<a class="sourceLine" id="cb13-6" title="6"><span class="op">+</span><span class="st">     </span>pairs</a>
<a class="sourceLine" id="cb13-7" title="7"><span class="op">+</span><span class="st"> </span>}, <span class="dt">model =</span> mglm)</a></code></pre></div>
</body>
</html>
